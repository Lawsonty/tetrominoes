<!DOCTYPE html>
<meta charset="UTF-8" />

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/5.4.0/math.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" type="text/javascript"></script>
    <script src="js/multi.js" type="text/javascript"></script>
    <script src="js/tetris.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/public/index.css">
</head>
<html>

<body>
    <!-- <p>Click the button to test the function.</p> -->
    <div id="boardContainer">
      <div class=board id="myBoard"></div>
  
      <div class=board id="oppBoard"></div>
    </div>

    <script>
        var tickCount = 0;
        var intervalObj = null;

        function initBoards() {

        }

        function boardUpdate(boardName) {
            var updateHTML = "";
            var blockColor = "";

            if (boardName == 'myBoard'){
                for (var i = state.free_blocks.length - 1; i >= 0; i--) {
                    updateHTML += `<span class=row>`
                    for (var j = 0; j < state.free_blocks[i].length; j++) {
                        if (state.free_blocks[i][j][1] == null) {
                            updateHTML += `<span class=block>&nbsp;</span>`;
                        } else {
                            updateHTML += `<span class=block style="background-color:${state.free_blocks[i][j][1]}">&nbsp;</span>`;
                        }
                        updateHTML += "</span>";
                    }
                    updateHTML += "<br>";
                }
            } else if (boardName == 'oppBoard') {
                for (var i = state.free_blocks.length - 1; i >= 0; i--) {
                    updateHTML += `<span class=row>`
                    for (var j = 0; j < state.free_blocks[i].length; j++) {
                        if (state.free_blocks[i][j][1] == null) {
                            updateHTML += `<span class=block>&nbsp;</span>`;
                        } else {
                            updateHTML += `<span class=block style="background-color:${state.free_blocks[i][j][1]}">&nbsp;</span>`;
                        }
                        updateHTML += "</span>";
                    }
                    updateHTML += "<br>";
                }
            }

            updateHTML += "Score: " + state.score;
            document.getElementById(boardName).innerHTML = updateHTML;
        }

        function myFunction() {
            if (tickCount % 10 == 0) {
                if(!state.tick()){
                    pauseFunc();
                }
            }
            
            sendBoard(document.getElementById('myBoard').innerHTML);

            boardUpdate('myBoard');
            state.clear_rows();
            tickCount++;
        }

        function oppUpdate() {
            boardUpdate
        }

        document.addEventListener("keypress", function (event) {
            if (event.code == "ArrowLeft") {
                state.shift_tetramino(-1, 0);
            }
            if (event.code == "ArrowUp") {
                state.rotate_tetramino();
            }
            if (event.code == "ArrowRight") {
                state.shift_tetramino(1, 0);
            }
            if (event.code == "ArrowDown") {
                state.shift_tetramino(0, -1);
                console.log("down");
            }
            if (event.code == "Space") {
                console.log("space");
            }
        })

        function startFunc() {
            if (intervalObj == null) {
                intervalObj = window.setInterval(myFunction, 100);
            }
        }

        function pauseFunc() {
            window.clearInterval(intervalObj);
            intervalObj = null;
            boardUpdate('myBoard');
            sendBoard(document.getElementById('myBoard').innerHTML);
        }

        function resetFunc() {
            pauseFunc();
            state.reset();
            boardUpdate('myBoard');
            sendBoard(document.getElementById('myBoard').innerHTML);
        }

        boardUpdate('myBoard');
        boardUpdate('oppBoard');

        onPageLoaded(document.getElementById('oppBoard'));
    </script>

    <div id="btnDiv">
        <button onclick="startFunc()">Start</button>
        <button onclick="pauseFunc()">Pause</button>
        <button onclick="resetFunc()">Reset</button>
    </div>
</body>

</html>